<?php
//this file is part of PHP LOGIN(Any Database)
//Copyright (C)2010 Shashwat Srivastava ( darklrd@gmail.com )
//				 	Apeksha Singh (apeksha0701@gmail.com)
//Powered by www.bOtskOOl.com
//
//This program is free software; you can redistribute it and/or
//modify it under the terms of the GNU General Public License
//as published by the Free Software Foundation; either
//version 2 of the License, or (at your option) any later version.
//
//This program is distributed in the hope that it will be useful,
//but WITHOUT ANY WARRANTY; without even the implied warranty of
//MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//GNU General Public License for more details.
//
//You should have received a copy of the GNU General Public License
//along with this program; if not, see <http://www.gnu.org/licenses/>.
session_start();

require "./data/settings.php";

class Login 
{
private $username;
private $password;	



public function __construct() 
{

$this->connect();
if(!isset($_SESSION['val']))
{
$_SESSION['val'] = false;
}		
}
		
public function connect() 
{	
global $LOGIN_DB_HOSTNAME,$LOGIN_DB_PWD,$LOGIN_DB_UNAME,$LOGIN_DB_NAME;
mysql_connect($LOGIN_DB_HOSTNAME,$LOGIN_DB_UNAME,$LOGIN_DB_PWD) OR die("Cannot connect to MySQL server!");	
mysql_select_db($LOGIN_DB_NAME) OR die("Cannot select database!");
}


public function verify1($username, $password,$chek_value) 
{
$this->username=$username;
$this->password=$password;
$result=mysql_query("Select * from user_info where Username='$username'") ;
while($row1= mysql_fetch_array($result))
{
$pwd=$row1['Password'];
if($password==$pwd)
{
$this->sessionverify();
if($chek_value)
{
$this->set_cookie();
}
//echo  "<script>alert(\"login successful\")</script><br>"; 
//echo "<script>location.replace(\"$_SESSION[destination]\")</script><br>";
header("Location: $_SESSION[destination]");
break; 
}
else
{
echo  "<script>alert(\"Username or password doesnt match!!!!\")</script><br>"; 
echo "<script>location.replace(\"login.php\")</script><br>";
}

}
}

public function sessionverify() 
{	
$_SESSION['val'] = true;
$_SESSION['username'] = $this->username;
$_SESSION['password'] = $this->password;
}

public function set_cookie() 
{	
setcookie("user", $this->username, time()+3600);
setcookie("pwd", $this->password, time()+3600);
}

public function destroy_cookie() 
{	
setcookie("user", $this->username, time()-3600);
setcookie("pwd", $this->password, time()-3600);
}

public function sessiondestroy() 
{	
unset($_SESSION['username']);
session_destroy();
$_SESSION['val']=false;
echo "<script>location.replace(\"login.php\")</script><br>";
}



public function register($username, $password,$email) 
{
$result=mysql_query("INSERT INTO user_info (username,password,email)
VALUES ('$username','$password','$email')") ;

}


public function chek_avail($username) 
{
$length=strlen($username);
if($length==0)
$res=1;
else if($length>5 && $length<32)
{
$res=4;
$result = mysql_query("SELECT * from user_info");
while($row = mysql_fetch_array($result))
  {
  if(strcmp($username,$row['Username'])==0)
  $res=3;
  }
}
else
$res=2;
echo $res; 
}

public function verify_im($capcha) 
{
$key;
if(!strcmp($capcha,$_SESSION['vercode'])==0)
{
$key=1;
echo $key;
}
else
{
$key=2;
echo $key;
} 
}

public function chek_pwd($password) 
{
$length=strlen($password);
$var;
		if($length==0 || $length<=4)
		{
			$var=1;
			echo $var;
			
		}
		else if($length>4 && $length<=8)
		{
		    $var=2;
			echo $var;;	
		}
		else if($length>8 && $length<=12)
		{
			$var=3;
		echo $var;		
			
		}
		else if($length>12)
		{
		$var=4;
			echo $var;	
			
		}
	return;
}

public function forgot_pwd($email) 
{
	$result = mysql_query("SELECT * from user_info where email='$email'");
	if(mysql_num_rows($result) == 0)
	{
	echo  "<script>alert(\"We're sorry, but we could not find a user with that email address\")</script><br>"; 
	echo "<script>location.replace(\"forgot.php\")</script><br>";
	}
    while($row = mysql_fetch_array($result))
   {	
		echo  "<script>alert(\"Your username and password have been emailed to you\")</script><br>"; 
		$username = $row['username'];
		$password = $row['password'];
		$msg  = "Your login information is:\n\n";
		$msg .= "Username: $username\n";
		$msg .= "Password: $password\n";
		mail($email, "Login Information", $msg, "From:noreply@domain.com");
		//echo "<script>location.replace(\"login.php\")</script><br>";
	}
}


public function change($user,$old_pwd,$new_pwd,$cnew_pwd)
{
$result = mysql_query("SELECT * from user_info where Username='$user'");
while($row = mysql_fetch_array($result))
  {
  if(!strcmp($old_pwd,$row['Password'])==0)
  { 
	echo  "<script>alert(\"Wrong password\")</script><br>"; 
	echo "<script>location.replace(\"change.php\")</script><br>";
  }
 else if(!strcmp($new_pwd,$cnew_pwd)==0)
  {
    echo  "<script>alert(\"Passwords dont match\")</script><br>"; 
    echo "<script>location.replace(\"change.php\")</script><br>";
  }
 else
 {
mysql_query("UPDATE user_info SET password = '$new_pwd' WHERE Username ='$user'");
echo "<script>alert(\"password successfully changed\")</script><br>";
echo "<script>location.replace(\"index.php\")</script><br>";
break; 
}
}

}










}
?>